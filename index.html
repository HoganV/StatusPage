<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plex Status</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        /* Your existing CSS for styling the page */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #121212;
            color: #dcdcdc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1, h2 {
            color: #82aaff;
            margin-bottom: 10px;
        }

        #chartContainer {
            width: 100%;
            max-width: 900px;
            height: 30vh;
            margin-bottom: 30px;
            background: #1e1e1e;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        table {
            width: 100%;
            max-width: 900px;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background-color: #3a3f47;
            color: #82aaff;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #2a2a2a;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #1c1c1c;
            color: #dcdcdc;
            font-size: 14px;
            margin-bottom: 10px;
        }

        footer {
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>

<h1>Uptime and Outage Tracker</h1>
<h2><span id="statusIcon">ðŸŸ¢</span> <a href="https://plex.hoganv.com/">plex.hoganv.com</a></h2>

<div id="chartContainer">
    <canvas id="statusChart"></canvas>
</div>

<table id="logTable">
    <thead>
        <tr>
            <th><select id="timestampFilter"><option value="">All</option></select></th>
            <th><select id="statusFilter"><option value="">All</option></select></th>
            <th><select id="actionFilter"><option value="">All</option></select></th>
        </tr>
        <tr>
            <th>Timestamp</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <!-- Table rows will be dynamically populated here -->
    </tbody>
</table>

<footer>
    <p id="footerText">&copy; <span id="year"></span> Hogan VanderMeulen</p>
</footer>

<script>
    let logData = []; // Store all rows after fetching CSV
    const chunkSize = 50; // Number of rows to load each time
    let currentChunk = 0; // Track current "page" of data

    document.getElementById('year').textContent = new Date().getFullYear();

    async function updateStatusIcon() {
        try {
            const response = await fetch(`PlexLog.csv?cacheBuster=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status})`);
            const data = await response.text();

            const rows = data.trim().split('\n').slice(1); // Skip header
            const latestRow = rows[rows.length - 1].split(',');
            const [rawTimestamp, status, action] = latestRow.map(entry => entry.trim());

            const timestampWithoutDay = rawTimestamp.slice(4);
            const [datePart, timePart] = timestampWithoutDay.split(' ');
            const [month, day, year] = datePart.split('/');
            const isoTimestamp = `${year}-${month}-${day}T${timePart}`;
            const latestTimestamp = new Date(isoTimestamp);

            if (isNaN(latestTimestamp.getTime())) return;

            const currentTime = new Date();
            const timeDifference = (currentTime - latestTimestamp) / 1000 / 60;

            const isRunning = status === "Running";
            const isRecent = timeDifference <= 10;
            document.getElementById("statusIcon").textContent = (isRunning && isRecent) ? "ðŸŸ¢" : "ðŸ”´";

        } catch (error) {
            console.error("Error fetching or processing the CSV:", error);
        }
    }

    async function fetchCSV() {
        try {
            const response = await fetch(`PlexLog.csv?cacheBuster=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status})`);
            const data = await response.text();
            const rows = data.split('\n').slice(1); // Skip header row
            logData = rows.map(row => {
                const [Timestamp, Status, Action] = row.split(',').map(value => value ? value.trim() : "");
                return { Timestamp, Status, Action };
            });
            filterAndRenderTable(); // Initial render with all data loaded
        } catch (error) {
            console.error("Error fetching or parsing the CSV file:", error);
        }
    }

    function filterAndRenderTable() {
        const timestampFilter = document.getElementById('timestampFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
        const actionFilter = document.getElementById('actionFilter').value.toLowerCase();

        const filteredData = logData.filter(entry => {
            const timestampText = (entry.Timestamp || "").toLowerCase();
            const statusText = (entry.Status || "").toLowerCase();
            const actionText = (entry.Action || "").toLowerCase();

            return (timestampFilter === "" || timestampText.includes(timestampFilter)) &&
                   (statusFilter === "" || statusText === statusFilter) &&
                   (actionFilter === "" || actionText === actionFilter);
        });

        document.querySelector('#logTable tbody').innerHTML = '';
        currentChunk = 0;

        function loadFilteredChunk() {
            const start = currentChunk * chunkSize;
            const end = start + chunkSize;

            filteredData.slice(start, end).forEach(entry => {
                const row = document.createElement('tr');
                Object.values(entry).forEach(text => {
                    const cell = document.createElement('td');
                    cell.textContent = text || "";
                    row.appendChild(cell);
                });
                document.querySelector('#logTable tbody').prepend(row); // Newest at the top
            });

            currentChunk++;
        }

        loadFilteredChunk();

        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                loadFilteredChunk();
            }
        });
    }

    document.getElementById('timestampFilter').addEventListener('change', filterAndRenderTable);
    document.getElementById('statusFilter').addEventListener('change', filterAndRenderTable);
    document.getElementById('actionFilter').addEventListener('change', filterAndRenderTable);

    fetchCSV(); // Fetch CSV on page load
    updateStatusIcon(); // Update status icon on page load
</script>

</body>
</html>
